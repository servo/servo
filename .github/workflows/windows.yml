name: Windows

on:
  workflow_call:
    inputs:
      profile:
        required: false
        default: "release"
        type: string
      build-args:
        default: ""
        required: false
        type: string
      unit-tests:
        required: false
        default: false
        type: boolean
      build-libservo:
        required: false
        default: false
        type: boolean
      upload_zip:
        required: false
        default: false
        type: boolean
      force-github-hosted-runner:
        required: false
        type: boolean
        default: false
      bencher:
        required: false
        default: false
        type: boolean
    outputs:
      artifact_ids:
        value: ${{ jobs.build.outputs.release_artifact_ids }}
        description: Comma-separated list of artifact IDs for the release artifacts

  workflow_dispatch:
    inputs:
      profile:
        required: false
        default: "release"
        options: ["release", "debug", "production"]
        type: choice
      unit-tests:
        required: false
        default: false
        type: boolean
      build-libservo:
        required: false
        default: false
        type: boolean
      force-github-hosted-runner:
        required: false
        type: boolean
        default: false
      bencher:
        required: false
        default: false
        type: boolean

env:
  RUST_BACKTRACE: 1
  SHELL: /bin/bash
  CARGO_TARGET_DIR: C:\\a\\servo\\servo\\target
  # clang_sys will search msys path before Program Files\LLVM
  # so we need to override this behaviour until we update clang-sys
  # https://github.com/KyleMayes/clang-sys/issues/150
  LIBCLANG_PATH: C:\Program Files\LLVM\bin
  RUSTUP_WINDOWS_PATH_ADD_BIN: 1

jobs:
  # Runs the underlying job (“workload”) on a self-hosted runner if available,
  # with the help of a `runner-select` job and a `runner-timeout` job.
  runner-select:
    runs-on: ubuntu-24.04
    outputs:
      unique-id: ${{ steps.select.outputs.unique-id }}
      selected-runner-label: ${{ steps.select.outputs.selected-runner-label }}
      runner-type-label: ${{ steps.select.outputs.runner-type-label }}
      is-self-hosted: ${{ steps.select.outputs.is-self-hosted }}
    steps:
      - name: Runner select
        id: select
        uses: servo/ci-runners/actions/runner-select@6d88b19dda997f1ce2a11e4c1c34717c2bbcafba
        with:
          GITHUB_TOKEN: ${{ github.token }}
          github-hosted-runner-label: windows-2022
          self-hosted-image-name: servo-windows10
          # You can disable self-hosted runners globally by creating a repository variable named
          # NO_SELF_HOSTED_RUNNERS with any non-empty value.
          # <https://github.com/servo/servo/settings/variables/actions>
          NO_SELF_HOSTED_RUNNERS: ${{ vars.NO_SELF_HOSTED_RUNNERS }}
          # Any other boolean conditions that disable self-hosted runners go here.
          force-github-hosted-runner: ${{ inputs.force-github-hosted-runner }}

  build:
    needs:
      - runner-select
    name: Windows Build [${{ needs.runner-select.outputs.unique-id }}]
    runs-on: ${{ needs.runner-select.outputs.selected-runner-label }}
    outputs:
      release_artifact_ids: ${{ steps.artifact_ids.outputs.release_artifact_ids }}
    steps:
      - uses: servo/ci-runners/actions/checkout@6d88b19dda997f1ce2a11e4c1c34717c2bbcafba

      - name: ccache
        # FIXME: “Error: Restoring cache failed: Error: Unable to locate executable file: sh.”
        if: ${{ runner.environment != 'self-hosted' }}
        uses: hendrikmuhs/ccache-action@v1.2
      - if: ${{ runner.environment != 'self-hosted' }}
        run: |
          echo CCACHE=ccache >> $GITHUB_ENV

      # Install missing tools in a GitHub-hosted runner.
      - name: Install wixtoolset
        if: ${{ runner.environment != 'self-hosted' }}
        run: |
          winget install --silent --exact WiXToolset.WiXToolset
          echo "C:\\Program Files (x86)\\WiX Toolset v3.11\\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
      - name: Setup Python
        if: ${{ runner.environment != 'self-hosted' }}
        uses: ./.github/actions/setup-python
      - name: Bootstrap
        if: ${{ runner.environment != 'self-hosted' }}
        run: |
          .\mach fetch
          .\mach bootstrap-gstreamer
      # For some reason WiX isn't currently on the GitHub runner path. This is a
      # temporary workaround until that is fixed.
      - name: Add WiX to Path
        if: ${{ runner.environment != 'self-hosted' }}
        run: |
          "$env:WIX\bin" >> $env:GITHUB_PATH

      # Always install crown, even on self-hosted runners, because it is tightly
      # coupled to the rustc version, and we may have the wrong version if the
      # commit we are building uses a different rustc version.
      - name: Install crown
        run: cargo install --path support/crown --force
      - name: Debug logging for incremental builds
        if: ${{ runner.environment == 'self-hosted' }}
        run: |
          cat C:\init\incremental_build_debug.txt
          echo "`$env:LIBCLANG_PATH now = $env:LIBCLANG_PATH"
          echo "`$env:PATH now = $env:PATH"

      - name: Build (${{ inputs.profile }})
        run: |
          .\mach build --use-crown --locked --profile ${{ inputs.profile }} ${{ inputs.build-args }}
          cp C:\a\servo\servo\target\cargo-timings C:\a\servo\servo\target\cargo-timings-windows -Recurse
      - name: Copy resources
        # GitHub-hosted runners sometimes check out the repo on D: drive.
        if: ${{ runner.environment != 'self-hosted' && startsWith(github.workspace, 'D:\') }}
        run: cp D:\a\servo\servo\resources C:\a\servo\servo -Recurse
      - name: Smoketest
        run: .\mach smoketest --profile ${{ inputs.profile }}
      - name: Install cargo nextest
        if: ${{ runner.environment != 'self-hosted' }}
        uses: taiki-e/install-action@v2
        with:
          tool: nextest
      # On self-hosted windows runners the install-action fails
      - name: Install cargo nextest (self-hosted)
        if: ${{ runner.environment == 'self-hosted' }}
        run: cargo install cargo-nextest --locked
      - name: Unit tests
        if: ${{ inputs.unit-tests }}
        id: run_unit_tests
        env:
          NEXTEST_RETRIES: 3 # https://github.com/servo/servo/issues/30683
        run: ./mach test-unit --profile ${{ inputs.profile }} --nextest-profile ci
      # We upload the test-results to Codecov to help us identify flaky unit-tests.
      - name: Upload test results to Codecov
        # Upload test results to Codecov, also for failed unit-tests, but only
        # if unit-tests were supposed to run, and not if they were skipped (e.g., due
        # to an earlier failure).
        if: ${{ !cancelled() && steps.run_unit_tests.conclusion != 'skipped' }}
        uses: codecov/codecov-action@v5
        with:
          report_type: test_results
          files: target/nextest/ci/junit.xml
          disable_search: true
          flags: unittests,unittests-windows,unittests-windows-${{ inputs.profile }}
          token: ${{ secrets.CODECOV_TOKEN }}
      - name: Devtools tests
        if: ${{ false && inputs.unit-tests }}  # FIXME #39273
        run: .\mach test-devtools --profile ${{ inputs.profile }}
      - name: Archive build timing
        uses: actions/upload-artifact@v6
        with:
          name: cargo-timings-windows-${{ inputs.profile }}
          # Using a wildcard here ensures that the archive includes the path.
          path: C:\\a\\servo\\servo\\target\\cargo-timings-*
      - name: Build mach package
        run: .\mach package --profile ${{ inputs.profile }}
      # These files are available
      # MSI Installer: C:\a\servo\servo\target\${{ inputs.profile }}\msi\Installer.msi
      # Bundle: C:\a\servo\servo\target\${{ inputs.profile }}\msi\Servo.exe
      # Zip: C:\a\servo\servo\target\${{ inputs.profile }}\msi\Servo.zip
      - name: Upload artifact for mach package
        uses: actions/upload-artifact@v6
        id: upload-exe
        with:
          name: ${{ inputs.profile }}-binary-windows
          path: C:\\a\\servo\\servo\\target\\${{ inputs.profile }}\\msi\\Servo.exe
      - name: Upload artifact for mach package (zip)
        uses: actions/upload-artifact@v6
        id: upload-zip
        if: ${{ inputs.upload_zip }}
        with:
          name: ${{ inputs.profile }}-binary-windows-zip
          path: C:\\a\\servo\\servo\\target\\${{ inputs.profile }}\\msi\\Servo.zip
      - name: Collect artifact IDs needed by the release workflow
        id: artifact_ids
        shell: bash
        run: |
          ARTIFACT_IDS="${{steps.upload-exe.outputs.artifact-id}}"
          if [[ -n "${{steps.upload-zip.outputs.artifact-id}}" ]]; then
            ARTIFACT_IDS="${ARTIFACT_IDS},${{steps.upload-zip.outputs.artifact-id}}"
          fi
          echo "release_artifact_ids=${ARTIFACT_IDS}" >> $GITHUB_OUTPUT

  bencher:
    needs: ["build"]
    if: ${{ inputs.bencher && inputs.profile != 'debug' && github.event_name != 'workflow_dispatch' && github.event_name != 'merge_group' }}
    uses: ./.github/workflows/bencher.yml
    with:
      target: 'windows'
      profile: ${{ inputs.profile }}
      compressed-file-path: ''
      binary-path: ${{ inputs.profile }}-binary-windows/Servo.exe
      file-size: true
      speedometer: false
      dromaeo: false
    secrets: inherit

  build-libservo:
    if: ${{ inputs.build-libservo }}
    name: Build libservo and MSRV check
    runs-on: windows-2022
    steps:
      - uses: actions/checkout@v5
        if: github.event_name != 'pull_request_target'
        with:
          fetch-depth: 1
      # This is necessary to checkout the pull request if this run was triggered via a
      # `pull_request_target` event.
      - uses: actions/checkout@v5
        if: github.event_name == 'pull_request_target'
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 1
      - name: Setup Python
        uses: ./.github/actions/setup-python
      - name: Determine MSRV
        id: msrv
        uses: ./.github/actions/parse_msrv
      - name: Install MSRV
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ steps.msrv.outputs.rust_version }}
      - name: Compile libservo with MSRV
        run: |
          cargo +${{ steps.msrv.outputs.rust_version }} build -p libservo --locked --all-targets
