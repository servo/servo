name: Main

on:
  push:
    # Run the entire pipeline for 'main' even though the merge queue already runs checks
    # for every change. This just offers an extra layer of testing and covers the case of
    # random force pushes.
    branches: ["main"]
  pull_request:
    types: ['opened', 'synchronize']
    branches: ["**"]
  merge_group:
    types: [checks_requested]
  workflow_dispatch:

jobs:
  # Generate unique ids that distinguish each auto-runner build from other
  # auto-runner builds in the same workflow call tree.
  # FIXME: we should really do this in the “foo-platform-auto” build itself,
  # but needs-context expressions are busted in jobs.<job id>.concurrency,
  # despite being supported according to the docs:
  # <https://docs.github.com/en/actions/writing-workflows/workflow-syntax-for-github-actions#jobsjob_idconcurrency>
  unique-ids:
    name: Generate unique ids
    runs-on: ubuntu-latest
    outputs:
      win: ${{ steps.generate.outputs.win }}
    steps:
      - id: generate
        run: |
          win=$(LC_ALL=C < /dev/urandom tr -dC 0-9A-Za-z_- 2> /dev/null | head -c 8)
          echo "win=${{ github.repository }}/${{ github.run_id }}/$win" | tee -a "$GITHUB_OUTPUT"

  build-win:
    name: Windows
    if: ${{ github.event_name != 'pull_request' }}
    uses: ./.github/workflows/windows-auto.yml
    needs:
      - unique-ids
    with:
      unique-id: ${{ needs.unique-ids.outputs.win }}
      unit-tests: true
    secrets: inherit

  build-mac:
    name: Mac
    if: ${{ github.event_name != 'pull_request' }}
    uses: ./.github/workflows/mac.yml
    with:
      unit-tests: true
    secrets: inherit

  build-linux:
    name: Linux
    uses: ./.github/workflows/linux.yml
    with:
      unit-tests: true
      wpt-layout: ${{ github.event_name == 'pull_request' && 'none' || '2020' }}
    secrets: inherit

  build-android:
    name: Android
    if: ${{ github.event_name != 'pull_request' }}
    uses: ./.github/workflows/android.yml
    with:
      profile: "release"
    secrets: inherit

  build-ohos:
    name: OpenHarmony
    if: ${{ github.event_name != 'pull_request' }}
    uses: ./.github/workflows/ohos.yml
    with:
      profile: "release"

  build-result:
    name: Result
    runs-on: ubuntu-latest
    if: always()
    # needs all build to detect cancellation
    needs:
      - "build-win"
      - "build-mac"
      - "build-linux"
      - "build-android"
      - "build-ohos"
    steps:
      - name: Merge build timings
        uses: actions/upload-artifact/merge@v4
        with:
          name: cargo-timings
          pattern: cargo-timings-*
          delete-merged: true
      - name: Success
        if: ${{ !contains(needs.*.result, 'failure') && !contains(needs.*.result, 'cancelled') }}
        run: exit 0
      - name: Failure
        if: contains(needs.*.result, 'failure') || contains(needs.*.result, 'cancelled')
        run: exit 1
