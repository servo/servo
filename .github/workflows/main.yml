name: Main

on:
  push:
    # Run the entire pipeline for 'master' even though the merge queue already runs checks
    # for every change. This just offers an extra layer of testing and covers the case of
    # random force pushes.
    branches: ["master", "try"]
  pull_request:
    types: ['opened', 'synchronize']
    branches: ["**"]
  merge_group:
    types: [checks_requested]
  workflow_dispatch:

jobs:
  decision:
    name: Decision
    runs-on: ubuntu-20.04
    steps:
      # If an identical build exists that suceeded, skip this workflow run. We don't do
      # this check for pull_request and merge_group events, out of caution.
      - name: Skip previous identical builds
        if: ${{ github.event_name != 'pull_request' && github.event_name != 'merge_group' }}
        uses: actions/github-script@v6
        with:
          script: |
            if ((await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: "main.yml",
              head_sha: context.sha,
              status: "success",
            })).data.workflow_runs.length > 0)
              await github.rest.actions.cancelWorkflowRun({
                owner: context.repo.owner,
                repo: context.repo.repo,
                run_id: context.runId,
              });

  build-win:
    name: Windows
    if: ${{ github.event_name == 'push' || github.event_name == 'merge_group' }}
    needs: ["decision"]
    uses: ./.github/workflows/windows.yml
    with:
      unit-tests: true

  build-mac:
    name: Mac
    if: ${{ github.event_name == 'push' || github.event_name == 'merge_group' }}
    needs: ["decision"]
    uses: ./.github/workflows/mac.yml
    with:
      unit-tests: true

  build-linux:
    name: Linux
    needs: ["decision"]
    uses: ./.github/workflows/linux.yml
    with:
      wpt: 'test'
      layout: ${{ (github.event_name == 'push' || github.event_name == 'merge_group') && 'all' || 'none' }}
      unit-tests: ${{ github.event_name == 'push' || github.event_name == 'merge_group' }}

  build_result:
    name: Result
    runs-on: ubuntu-latest
    if: always()
    # needs all build to detect cancellation
    needs:
      - "decision"
      - "build-win"
      - "build-mac"
      - "build-linux"

    steps:
      - name: Mark the job as successful
        run: exit 0
        if: ${{ !contains(join(needs.*.result, ','), 'failure') && !contains(join(needs.*.result, ','), 'cancelled') }}
      - name: Mark the job as unsuccessful
        run: exit 1
        if: contains(join(needs.*.result, ','), 'failure') || contains(join(needs.*.result, ','), 'cancelled')
