VPATH=%VPATH%

RUSTC?=rustc
RUSTFLAGS?=

UNAME=$(shell uname)

ifeq ($(UNAME),Darwin)
    OSTYPE=darwin
endif
ifeq ($(UNAME),Linux)
    OSTYPE=linux
endif

RUSTFLAGS += -L $(VPATH)/src/rust-azure -L $(VPATH)/src/rust-sdl \
             -L $(VPATH)/src/rust-cocoa

RUST_SRC=$(shell find $(VPATH)/src -type f -name '*.rs')

SERVO_DEPS = \
	src/servo/servo.rc \
	$(RUST_SRC) \
	$(NULL)
CHECK_DEPS =
CLEAN_DEPS =

ifeq ($(OSTYPE),darwin)
    SERVO_DEPS += src/rust-cocoa/libcocoa.dummy
    # I want the cocoa check to come before the servo check since if cocoa
    # doesn't work neither does servo
    CHECK_DEPS += check-cocoa
    CLEAN_DEPS += clean-cocoa
endif

SERVO_DEPS += \
	src/rust-azure/libazure.dummy \
	src/rust-sdl/libsdl.dummy \
	$(NULL)

CHECK_DEPS += \
	check-sdl \
	check-azure \
	check-servo \
	$(NULL)

CLEAN_DEPS += \
	clean-sdl \
	clean-azure \
	clean-servo \
	$(NULL)

.PHONY:	all
all:    servo package

servo:	$(SERVO_DEPS)
	$(RUSTC) $(RUSTFLAGS) -o $@ $<

servo-test: $(SERVO_DEPS)
	$(RUSTC) $(RUSTFLAGS) --test -o $@ $<

src/rust-azure/libazure.dummy:
	make -C $(VPATH)/src/rust-azure

src/rust-sdl/libsdl.dummy:
	make -C $(VPATH)/src/rust-sdl

src/rust-cocoa/libcocoa.dummy:
	make -C $(VPATH)/src/rust-cocoa

check: $(CHECK_DEPS)

check-servo: servo-test
	./servo-test

.PHONY: check-azure
check-azure:
	make check -C $(VPATH)/src/rust-azure

.PHONY: check-sdl
check-sdl:
	make check -C $(VPATH)/src/rust-sdl

.PHONY: check-cocoa
check-cocoa:
	make check -C $(VPATH)/src/rust-cocoa

.PHONY:	clean
clean: $(CLEAN_DEPS)

.PHONY: clean-azure
clean-azure:
	make clean -C $(VPATH)/src/rust-azure

.PHONY: clean-sdl
clean-sdl:
	make clean -C $(VPATH)/src/rust-sdl

.PHONY: clean-cocoa
clean-cocoa:
	make clean -C $(VPATH)/src/rust-cocoa

.PHONY: clean-servo
clean-servo:
	rm -f servo servo-test

ifeq ($(OSTYPE),darwin)

package: servo
	mkdir -p Servo.app/Contents/MacOS/src/rust-cocoa
	mkdir -p Servo.app/Contents/MacOS/src/rust-sdl
	mkdir -p Servo.app/Contents/MacOS/src/rust-azure
	cp $(VPATH)/Info.plist Servo.app/Contents/
	cp servo Servo.app/Contents/MacOS/
	cp $(VPATH)/src/rust-cocoa/lib*.dylib Servo.app/Contents/MacOS/src/rust-cocoa/
	cp $(VPATH)/src/rust-sdl/lib*.dylib Servo.app/Contents/MacOS/src/rust-sdl/
	cp $(VPATH)/src/rust-azure/lib*.dylib Servo.app/Contents/MacOS/src/rust-azure/

else

.PHONY: package
package:

endif
