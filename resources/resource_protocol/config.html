<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Advanced Config</title>
    <style>
        body {
            padding: 0;
            display: flex;
            flex-direction: column;
        }

        input {
            border-radius: 4px;
        }

        .search {
            height: 24px;
            width: calc(100% - 6px);
            margin-top: 12px;
            margin-bottom: 12px;
            margin-right: 6px;
            padding: 4px;
        }

        table {
            border-collapse: collapse;
        }

        table, th, td {
            border: 0;
        }

        .even {
            background-color: #f0f0f0;
        }

        .value-editor {
            margin: 2px;
            padding: 2px;
        }

        .switch-button {
            margin: 2px;
            padding: 2px;
            border-radius: 4px;
            background: #cfcfcf;
            border: 0;
        }

        .icon {
            width: 24px;
            height: 24px;
        }

        .hidden {
            display: none;
        }

        .bold {
            font-weight: bold;
        }
    </style>
</head>
<body>
    <input class="search" type="text" placeholder="Search for a preference ..." aria-label="Search preferences" oninput="populate(this.value)">
    <table></table>
    <script>
        // Helper to create a TD with class and optional text
        function td(cls, text) {
            const cell = document.createElement('td');
            if (cls) cell.className = cls;
            if (text !== undefined) cell.textContent = text;
            return cell;
        }

        class PrefBoolRow extends HTMLTableRowElement {
            connectedCallback() {
                // Attributes are provided via data-*
                const pref = this.getAttribute('data-pref');
                const defaultValue = this.getAttribute('data-default') === 'true';
                let value = this.getAttribute('data-value') === 'true';

                const nameCell = td('pref-name', pref);
                const valueCell = td('value', String(value));
                valueCell.id = `value-${pref}`;
                if (value !== defaultValue) valueCell.classList.add('bold');

                const switcher = td('switcher');
                const btn = document.createElement('button');
                btn.className = 'switch-button';
                btn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="icon">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M7.5 21 3 16.5m0 0L7.5 12M3 16.5h13.5m0-13.5L21 7.5m0 0L16.5 12M21 7.5H7.5" />
                    </svg>`;
                btn.onclick = () => {
                    value = !value;
                    if (value === defaultValue) {
                        valueCell.classList.remove('bold');
                    } else {
                        valueCell.classList.add('bold');
                    }
                    navigator.servo.setBoolPreference(pref, value);
                    valueCell.textContent = String(value);
                };
                switcher.appendChild(btn);

                this.appendChild(nameCell);
                this.appendChild(valueCell);
                this.appendChild(switcher);
            }
        }

        class PrefIntRow extends HTMLTableRowElement {
            connectedCallback() {
                const pref = this.getAttribute('data-pref');
                const defaultValue = parseInt(this.getAttribute('data-default'));
                let value = parseInt(this.getAttribute('data-value'));

                const nameCell = td('pref-name', pref);

                const valueCell = document.createElement('td');
                valueCell.className = 'value';
                const valueSpan = document.createElement('span');
                valueSpan.className = 'value-entry';
                valueSpan.id = `value-${pref}`;
                valueSpan.textContent = String(value);
                if (value !== defaultValue) valueSpan.classList.add('bold');
                const input = document.createElement('input');
                input.type = 'number';
                input.className = 'value-editor hidden';
                input.id = `input-${pref}`;
                valueCell.appendChild(valueSpan);
                valueCell.appendChild(input);

                const switcher = td('switcher');
                const editBtn = document.createElement('button');
                editBtn.className = 'switch-button';
                editBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="icon">
                        <path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L6.832 19.82a4.5 4.5 0 0 1-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 0 1 1.13-1.897L16.863 4.487Zm0 0L19.5 7.125" />
                    </svg>`;
                const saveBtn = document.createElement('button');
                saveBtn.className = 'switch-button hidden';
                saveBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="icon">
                        <path stroke-linecap="round" stroke-linejoin="round" d="m4.5 12.75 6 6 9-13.5" />
                    </svg>`;

                editBtn.onclick = () => {
                    valueSpan.classList.add('hidden');
                    input.classList.remove('hidden');
                    input.value = String(value);
                    editBtn.classList.add('hidden');
                    saveBtn.classList.remove('hidden');
                };

                saveBtn.onclick = () => {
                    const newValue = parseInt(input.value);
                    navigator.servo.setIntPreference(pref, newValue);
                    value = newValue;
                    valueSpan.textContent = String(value);
                    if (value === defaultValue) {
                        valueSpan.classList.remove('bold');
                    } else {
                        valueSpan.classList.add('bold');
                    }
                    valueSpan.classList.remove('hidden');
                    input.classList.add('hidden');
                    editBtn.classList.remove('hidden');
                    saveBtn.classList.add('hidden');
                };

                switcher.appendChild(editBtn);
                switcher.appendChild(saveBtn);

                this.appendChild(nameCell);
                this.appendChild(valueCell);
                this.appendChild(switcher);
            }
        }

        class PrefStringRow extends HTMLTableRowElement {
            connectedCallback() {
                const pref = this.getAttribute('data-pref');
                const defaultValue = this.getAttribute('data-default') ?? '';
                let value = this.getAttribute('data-value') ?? '';

                const nameCell = td('pref-name', pref);

                const valueCell = document.createElement('td');
                valueCell.className = 'value';
                const valueSpan = document.createElement('span');
                valueSpan.className = 'value-entry';
                valueSpan.id = `value-${pref}`;
                valueSpan.textContent = value;
                if (value !== defaultValue) valueSpan.classList.add('bold');
                const input = document.createElement('input');
                input.type = 'text';
                input.className = 'value-editor hidden';
                input.id = `input-${pref}`;
                valueCell.appendChild(valueSpan);
                valueCell.appendChild(input);

                const switcher = td('switcher');
                const editBtn = document.createElement('button');
                editBtn.className = 'switch-button';
                editBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="icon">
                        <path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L6.832 19.82a4.5 4.5 0 0 1-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 0 1 1.13-1.897L16.863 4.487Zm0 0L19.5 7.125" />
                    </svg>`;
                const saveBtn = document.createElement('button');
                saveBtn.className = 'switch-button hidden';
                saveBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="icon">
                        <path stroke-linecap="round" stroke-linejoin="round" d="m4.5 12.75 6 6 9-13.5" />
                    </svg>`;

                editBtn.onclick = () => {
                    valueSpan.classList.add('hidden');
                    input.classList.remove('hidden');
                    input.value = value;
                    editBtn.classList.add('hidden');
                    saveBtn.classList.remove('hidden');
                };

                saveBtn.onclick = () => {
                    const newValue = input.value;
                    navigator.servo.setStringPreference(pref, newValue);
                    value = newValue;
                    valueSpan.textContent = value;
                    if (value === defaultValue) {
                        valueSpan.classList.remove('bold');
                    } else {
                        valueSpan.classList.add('bold');
                    }
                    valueSpan.classList.remove('hidden');
                    input.classList.add('hidden');
                    editBtn.classList.remove('hidden');
                    saveBtn.classList.add('hidden');
                };

                switcher.appendChild(editBtn);
                switcher.appendChild(saveBtn);

                this.appendChild(nameCell);
                this.appendChild(valueCell);
                this.appendChild(switcher);
            }
        }

        class PrefUnknownRow extends HTMLTableRowElement {
            connectedCallback() {
                const pref = this.getAttribute('data-pref');
                const value = this.getAttribute('data-value') ?? '';

                this.appendChild(td('pref-name', pref));
                this.appendChild(td('value', value));
            }
        }

        customElements.define('pref-bool-row', PrefBoolRow, { extends: 'tr' });
        customElements.define('pref-int-row', PrefIntRow, { extends: 'tr' });
        customElements.define('pref-string-row', PrefStringRow, { extends: 'tr' });
        customElements.define('pref-unknown-row', PrefUnknownRow, { extends: 'tr' });

        let all = navigator.servo.preferenceList();
        all.sort();
        const ALL = all;

        function populate(filter) {
            const table = document.querySelector('table');
            table.innerHTML = '';
            let prefs = [];
            if (filter === '' || filter === null || filter === undefined) {
                prefs = ALL;
            } else {
                // TODO: improve filtering
                for (let pref of ALL) {
                    let stripped_pref = pref.replaceAll('_', '');
                    let stripped_filter = filter.replaceAll('_', '').replaceAll(' ', '').toLowerCase();
                    if (stripped_pref.includes(stripped_filter)) {
                        prefs.push(pref);
                    }
                }
            }
            let counter = 0;
            for (let pref of prefs) {
                counter++;
                let ty = navigator.servo.preferenceType(pref);
                let value = navigator.servo.getPreference(pref);
                let defaultValue = navigator.servo.defaultValue(pref);
                const even = counter % 2 === 0;

                if (ty === 'bool') {
                    const row = document.createElement('tr', { is: 'pref-bool-row' });
                    row.setAttribute('data-pref', pref);
                    row.setAttribute('data-value', String(value));
                    row.setAttribute('data-default', String(defaultValue));
                    if (even) row.classList.add('even');
                    table.appendChild(row);
                } else if (ty === 'i64') {
                    const row = document.createElement('tr', { is: 'pref-int-row' });
                    row.setAttribute('data-pref', pref);
                    row.setAttribute('data-value', String(value));
                    row.setAttribute('data-default', String(defaultValue));
                    if (even) row.classList.add('even');
                    table.appendChild(row);
                } else if (ty === 'alloc::string::String') {
                    const row = document.createElement('tr', { is: 'pref-string-row' });
                    row.setAttribute('data-pref', pref);
                    row.setAttribute('data-value', String(value));
                    row.setAttribute('data-default', String(defaultValue));
                    if (even) row.classList.add('even');
                    table.appendChild(row);
                } else {
                    const row = document.createElement('tr', { is: 'pref-unknown-row' });
                    row.setAttribute('data-pref', pref);
                    row.setAttribute('data-value', String(value));
                    if (even) row.classList.add('even');
                    table.appendChild(row);
                }
            }
        }
        populate();
    </script>
</body>
</html>
